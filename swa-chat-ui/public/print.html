<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deep Research Report - Print Version</title>
    <style>
        /* å°åˆ·å°‚ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', 'Noto Sans JP', Meiryo, sans-serif;
            font-size: 14px;
            line-height: 1.8;
            color: #333;
            background: white;
            padding: 0;
            margin: 0;
        }

        /* å°åˆ·ã¨ã‚¹ã‚¯ãƒªãƒ¼ãƒ³å…±é€š */
        .print-container {
            max-width: 100%;
            margin: 0;
            padding: 0.7cm;
        }

        .header {
            text-align: center;
            margin-bottom: 1.2cm;
            padding-bottom: 0.5cm;
            border-bottom: 2px solid #667eea;
        }

        .header h1 {
            font-size: 24px;
            color: #667eea;
            margin-bottom: 0.5cm;
        }

        .header .timestamp {
            font-size: 12px;
            color: #666;
        }

        .message-section {
            margin-bottom: 1.2cm;
            page-break-inside: avoid;
            break-inside: avoid;
            border: 1px solid #eee;
            padding: 0.7cm;
            border-radius: 8px;
        }

        .message-header {
            font-weight: bold;
            font-size: 16px;
            color: #764ba2;
            margin-bottom: 1cm;
            page-break-after: avoid;
            break-after: avoid;
        }

        .message-content {
            line-height: 1.8;
        }

        .message-content h1,
        .message-content h2,
        .message-content h3 {
            page-break-after: avoid;
            break-after: avoid;
            page-break-inside: avoid;
            break-inside: avoid;
            margin-top: 1cm;
            margin-bottom: 0.5cm;
            color: #333;
        }

        .message-content h1 { font-size: 20px; }
        .message-content h2 { font-size: 18px; }
        .message-content h3 { font-size: 16px; }

        .message-content p {
            margin-bottom: 0.8cm;
            orphans: 3;
            widows: 3;
            page-break-inside: avoid;
            break-inside: avoid;
        }

        .message-content ul,
        .message-content ol {
            margin-left: 1cm;
            margin-bottom: 1cm;
            page-break-inside: avoid;
            break-inside: avoid;
        }

        .message-content li {
            margin-bottom: 0.3cm;
            page-break-inside: avoid;
            break-inside: avoid;
        }

        .message-content blockquote {
            border-left: 4px solid #667eea;
            padding-left: 1cm;
            margin: 1cm 0;
            font-style: italic;
            background: #f8f9fa;
            padding: 0.5cm 1cm;
            page-break-inside: avoid;
            break-inside: avoid;
        }

        .message-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 1cm 0;
            page-break-inside: avoid;
            break-inside: avoid;
        }

        .message-content th,
        .message-content td {
            border: 1px solid #ddd;
            padding: 0.3cm;
            text-align: left;
        }

        .message-content th {
            background: #f5f5f5;
            font-weight: bold;
        }

        .citation-link {
            color: #007bff;
            text-decoration: none;
            font-weight: bold;
            page-break-inside: avoid;
            break-inside: avoid;
        }

        .citation-link:after {
            content: " ğŸ”—";
            font-size: 0.8em;
        }

        /* å°åˆ·å°‚ç”¨è¨­å®š */
        @media print {
            @page {
                margin: 0.7cm;
                size: A4 portrait;
            }

            body {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .no-print {
                display: none !important;
            }

            .message-section {
                margin-bottom: 1.2cm;
                page-break-inside: avoid;
                break-inside: avoid;
            }
        }

        /* ã‚¹ã‚¯ãƒªãƒ¼ãƒ³è¡¨ç¤ºç”¨ï¼ˆå°åˆ·ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰ */
        @media screen {
            body {
                background: #f5f5f5;
                padding: 2cm 0;
            }

            .print-container {
                background: white;
                box-shadow: 0 0 20px rgba(0,0,0,0.1);
                margin: 0 auto;
                max-width: 21cm; /* A4å¹… */
                min-height: 29.7cm; /* A4é«˜ã• */
            }

            .print-controls {
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 1000;
            }

            .print-btn {
                background: #667eea;
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 5px;
                cursor: pointer;
                font-size: 14px;
                margin-left: 10px;
            }

            .print-btn:hover {
                background: #5a6fd8;
            }
        }
    </style>
</head>
<body>
    <div class="print-controls no-print">
        <label style="color: #333; margin-right: 10px;">
            <input type="radio" name="printMode" value="final" checked onchange="updateDisplayMode()"> Final Report
        </label>
        <label style="color: #333; margin-right: 20px;">
            <input type="radio" name="printMode" value="all" onchange="updateDisplayMode()"> å…¨ã‚„ã‚Šå–ã‚Š
        </label>
        <button class="print-btn" onclick="window.print()">ğŸ–¨ï¸ å°åˆ·/PDFå‡ºåŠ›</button>
        <button class="print-btn" onclick="window.close()">âœ• é–‰ã˜ã‚‹</button>
    </div>

    <div class="print-container">
        <div class="header">
            <h1>Deep Research Report</h1>
            <div class="timestamp" id="timestamp"></div>
        </div>

        <div id="content">
            <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯JavaScriptã§å‹•çš„ã«æŒ¿å…¥ -->
            <div class="message-section">
                <div class="message-header">ğŸ”„ ãƒ¬ãƒãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
                <div class="message-content">
                    <p>ãƒãƒ£ãƒƒãƒˆç”»é¢ã‹ã‚‰ã“ã®ãƒšãƒ¼ã‚¸ã‚’é–‹ã„ã¦ãã ã•ã„ã€‚</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’è¨­å®š
        document.getElementById('timestamp').textContent = 
            'ç”Ÿæˆæ—¥æ™‚: ' + new Date().toLocaleString('ja-JP');

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let currentMessages = [];

        // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¾ãŸã¯localStorageã‹ã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—
        function loadMessages() {
            try {
                // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—ã‚’è©¦è¡Œ
                const urlParams = new URLSearchParams(window.location.search);
                const messagesParam = urlParams.get('messages');
                
                let messages = [];
                
                if (messagesParam) {
                    messages = JSON.parse(decodeURIComponent(messagesParam));
                } else {
                    // localStorageã‹ã‚‰å–å¾—
                    const storedMessages = localStorage.getItem('printMessages');
                    if (storedMessages) {
                        messages = JSON.parse(storedMessages);
                        // ä½¿ç”¨å¾Œã¯å‰Šé™¤
                        localStorage.removeItem('printMessages');
                    }
                }

                if (messages && messages.length > 0) {
                    currentMessages = messages;
                    renderMessages(messages);
                } else {
                    document.getElementById('content').innerHTML = `
                        <div class="message-section">
                            <div class="message-header">âš ï¸ ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>
                            <div class="message-content">
                                <p>ãƒãƒ£ãƒƒãƒˆç”»é¢ã®ã€ŒğŸ“„ PDFç”¨è¡¨ç¤ºã€ãƒœã‚¿ãƒ³ã‹ã‚‰ã“ã®ãƒšãƒ¼ã‚¸ã‚’é–‹ã„ã¦ãã ã•ã„ã€‚</p>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('content').innerHTML = `
                    <div class="message-section">
                        <div class="message-header">âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>
                        <div class="message-content">
                            <p>ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</p>
                            <p>ã‚¨ãƒ©ãƒ¼: ${error.message}</p>
                        </div>
                    </div>
                `;
            }
        }

        // è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰æ›´æ–°
        function updateDisplayMode() {
            if (currentMessages.length > 0) {
                renderMessages(currentMessages);
            }
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        function renderMessages(messages) {
            const content = document.getElementById('content');
            content.innerHTML = '';
            
            // é¸æŠã•ã‚ŒãŸãƒ¢ãƒ¼ãƒ‰ã‚’å–å¾—
            const printMode = document.querySelector('input[name="printMode"]:checked')?.value || 'final';
            
            if (printMode === 'final') {
                // Final Reportã®ã¿ã‚’è¡¨ç¤ºï¼ˆæœ€å¾Œã®AIãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰
                const aiMessages = messages.filter(msg => msg.type === 'ai' && msg.content);
                const finalReport = aiMessages[aiMessages.length - 1]; // æœ€å¾Œã®AIãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

                if (finalReport) {
                    const section = document.createElement('div');
                    section.className = 'message-section';
                    
                    // ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã‚’HTMLã«å¤‰æ›
                    const processedContent = processMarkdown(finalReport.content);
                    
                    section.innerHTML = `
                        <div class="message-header">ğŸ“‹ Final Research Report</div>
                        <div class="message-content">${processedContent}</div>
                    `;
                    
                    content.appendChild(section);
                } else {
                    content.innerHTML = `
                        <div class="message-section">
                            <div class="message-header">ğŸ“ ãƒ¬ãƒãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</div>
                            <div class="message-content">
                                <p>Final ReportãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>
                            </div>
                        </div>
                    `;
                }
            } else {
                // å…¨ã‚„ã‚Šå–ã‚Šã‚’è¡¨ç¤º
                let messageCount = 0;
                messages.forEach((message) => {
                    if (message.type === 'user' && message.content) {
                        messageCount++;
                        const section = document.createElement('div');
                        section.className = 'message-section';
                        
                        section.innerHTML = `
                            <div class="message-header">ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼è³ªå• ${messageCount}</div>
                            <div class="message-content"><p>${message.content}</p></div>
                        `;
                        
                        content.appendChild(section);
                    } else if (message.type === 'ai' && message.content) {
                        const section = document.createElement('div');
                        section.className = 'message-section';
                        
                        // ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã‚’HTMLã«å¤‰æ›
                        const processedContent = processMarkdown(message.content);
                        
                        section.innerHTML = `
                            <div class="message-header">ğŸ¤– AIå›ç­” ${messageCount}</div>
                            <div class="message-content">${processedContent}</div>
                        `;
                        
                        content.appendChild(section);
                    }
                });

                if (content.children.length === 0) {
                    content.innerHTML = `
                        <div class="message-section">
                            <div class="message-header">ğŸ“ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Šã¾ã›ã‚“</div>
                            <div class="message-content">
                                <p>è¡¨ç¤ºã§ãã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>
                            </div>
                        </div>
                    `;
                }
            }
        }

        // ç°¡æ˜“ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³å‡¦ç†
        function processMarkdown(content) {
            if (!content) return '';
            
            let processed = content;
            
            // ãƒ†ãƒ¼ãƒ–ãƒ«å‡¦ç†ï¼ˆæœ€åˆã«è¡Œã†ï¼‰
            processed = processMarkdownTables(processed);
            
            // è¦‹å‡ºã—å‡¦ç†
            processed = processed.replace(/^### (.*$)/gm, '<h3>$1</h3>');
            processed = processed.replace(/^## (.*$)/gm, '<h2>$1</h2>');
            processed = processed.replace(/^# (.*$)/gm, '<h1>$1</h1>');
            
            // å¤ªå­—å‡¦ç†
            processed = processed.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            processed = processed.replace(/__(.*?)__/g, '<strong>$1</strong>');
            
            // æ–œä½“å‡¦ç†
            processed = processed.replace(/\*(.*?)\*/g, '<em>$1</em>');
            processed = processed.replace(/_(.*?)_/g, '<em>$1</em>');
            
            // ãƒªã‚¹ãƒˆå‡¦ç†ï¼ˆbullet pointsï¼‰
            processed = processed.replace(/^[\-\*\+] (.+)$/gm, '<li>$1</li>');
            processed = processed.replace(/^ãƒ» (.+)$/gm, '<li>$1</li>');
            processed = processed.replace(/^â€¢ (.+)$/gm, '<li>$1</li>');
            
            // liã‚¿ã‚°ã‚’ulã§å›²ã‚€
            processed = processed.replace(/((?:<li>.*<\/li>\s*)+)/g, '<ul>$1</ul>');
            
            // ç•ªå·ä»˜ããƒªã‚¹ãƒˆå‡¦ç†
            processed = processed.replace(/^\d+\. (.+)$/gm, '<li>$1</li>');
            processed = processed.replace(/((?:<li>.*<\/li>\s*)+)/g, (match) => {
                if (match.includes('1. ')) {
                    return '<ol>' + match.replace(/^\d+\. /gm, '') + '</ol>';
                }
                return '<ul>' + match + '</ul>';
            });
            
            // æ®µè½å‡¦ç†
            processed = processed.replace(/\n\n/g, '</p><p>');
            processed = '<p>' + processed + '</p>';
            
            // ç©ºã®æ®µè½ã‚’å‰Šé™¤
            processed = processed.replace(/<p><\/p>/g, '');
            processed = processed.replace(/<p>\s*<\/p>/g, '');
            
            // Citationå‡¦ç†ï¼ˆã€æ•°å­—:æ•°å­—â€ sourceã€‘å½¢å¼ï¼‰
            processed = processed.replace(/ã€(\d+):(\d+)â€ ([^ã€‘]+)ã€‘/g, 
                '<span class="citation-link">ã€$1:$2â€ $3ã€‘</span>');
            
            // blockquoteå‡¦ç†
            processed = processed.replace(/^> (.*)$/gm, '<blockquote>$1</blockquote>');
            
            return processed;
        }

        // ãƒ†ãƒ¼ãƒ–ãƒ«å‡¦ç†å°‚ç”¨é–¢æ•°
        function processMarkdownTables(content) {
            const lines = content.split('\n');
            const result = [];
            let i = 0;
            
            while (i < lines.length) {
                const line = lines[i].trim();
                
                // ãƒ†ãƒ¼ãƒ–ãƒ«è¡Œã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆ|ã‚’å«ã‚€è¡Œï¼‰
                if (line.includes('|') && line.split('|').length >= 3) {
                    // ãƒ†ãƒ¼ãƒ–ãƒ«ã®é–‹å§‹ã‚’æ¤œå‡º
                    const tableLines = [];
                    let j = i;
                    
                    // é€£ç¶šã™ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«è¡Œã‚’åé›†
                    while (j < lines.length && lines[j].trim().includes('|')) {
                        const tableLine = lines[j].trim();
                        if (tableLine.split('|').length >= 3) {
                            tableLines.push(tableLine);
                        }
                        j++;
                    }
                    
                    if (tableLines.length >= 2) {
                        // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’HTMLã«å¤‰æ›
                        const tableHtml = convertTableToHtml(tableLines);
                        result.push(tableHtml);
                        i = j; // ãƒ†ãƒ¼ãƒ–ãƒ«ã®å¾Œã®è¡Œã«ç§»å‹•
                        continue;
                    }
                }
                
                result.push(lines[i]);
                i++;
            }
            
            return result.join('\n');
        }

        // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’HTMLã«å¤‰æ›
        function convertTableToHtml(tableLines) {
            if (tableLines.length < 2) return tableLines.join('\n');
            
            let html = '<table>\n';
            
            // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã®å‡¦ç†
            const headerCells = tableLines[0].split('|')
                .map(cell => cell.trim())
                .filter(cell => cell !== '');
            
            html += '<thead>\n<tr>\n';
            headerCells.forEach(cell => {
                html += `<th>${cell}</th>\n`;
            });
            html += '</tr>\n</thead>\n';
            
            // åŒºåˆ‡ã‚Šè¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆ2è¡Œç›®ã¯é€šå¸¸ |---|---|--- ã®ã‚ˆã†ãªå½¢å¼ï¼‰
            let dataStartIndex = 1;
            if (tableLines[1].includes('---') || tableLines[1].includes('===')) {
                dataStartIndex = 2;
            }
            
            // ãƒ‡ãƒ¼ã‚¿è¡Œã®å‡¦ç†
            html += '<tbody>\n';
            for (let i = dataStartIndex; i < tableLines.length; i++) {
                const dataCells = tableLines[i].split('|')
                    .map(cell => cell.trim())
                    .filter(cell => cell !== '');
                
                if (dataCells.length > 0) {
                    html += '<tr>\n';
                    dataCells.forEach(cell => {
                        html += `<td>${cell}</td>\n`;
                    });
                    html += '</tr>\n';
                }
            }
            html += '</tbody>\n';
            html += '</table>';
            
            return html;
        }

        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«å®Ÿè¡Œ
        window.addEventListener('load', loadMessages);
    </script>
</body>
</html>